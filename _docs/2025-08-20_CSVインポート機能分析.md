# CSVインポート機能分析レポート

## 📅 分析日時
2025年8月20日 12:46 JST

## 🎯 分析目的
CSVファイルに日付が正常に記入されない問題の根本原因を特定し、家計簿アプリとして不足している機能を分析する

## 🚨 問題の根本原因

### 1. CSVインポート機能の完全欠如
**現在の状況**: CSVエクスポート機能のみ実装済み
**問題点**: 
- `export_to_csv()`関数は存在するが、インポート機能が一切ない
- 外部CSVファイルからのデータ取り込みが不可能
- 他の家計簿アプリからの移行ができない

### 2. 日付形式対応の限定的実装
**現在の実装**:
```python
def validate_input(date_str, amount_str):
    if not re.match(r'^\d{4}-\d{2}-\d{2}$', date_str):
        QMessageBox.warning(None, "入力エラー", "日付はYYYY-MM-DD形式で入力してください。")
        return False
```

**問題点**:
- YYYY-MM-DD形式のみ対応
- 令和yy年mm月dd日形式に対応していない
- Ryy/mm/dd形式に対応していない
- yyyy/mm/dd形式に対応していない

### 3. CSVファイル形式検証機能の不足
**問題点**:
- ヘッダー行の確認機能なし
- 列の順序チェック機能なし
- データ型変換機能なし
- エンコーディング検出機能なし

## 🛠️ 必要な実装（優先度順）

### 🔥 最優先: CSVインポート機能
```python
def import_from_csv(filename):
    """
    CSVファイルからデータをインポートする
    Args:
        filename (str): インポートするCSVファイルのパス
    Returns:
        bool: インポート成功時True
    """
    try:
        # 1. ファイル読み込み（エンコーディング自動検出）
        # 2. ヘッダー行の確認
        # 3. 列の順序チェック
        # 4. 日付形式変換
        # 5. データ検証
        # 6. DBへの挿入
        pass
    except Exception as e:
        logging.error(f"CSVインポートエラー: {e}")
        return False
```

### ⚡ 高優先度: 日付形式変換機能
```python
def convert_date_format(date_str):
    """
    様々な日付形式をYYYY-MM-DDに変換
    Args:
        date_str (str): 変換対象の日付文字列
    Returns:
        str: YYYY-MM-DD形式の日付文字列
    """
    # 令和yy年mm月dd日 → YYYY-MM-DD
    # Ryy/mm/dd → YYYY-MM-DD
    # yyyy/mm/dd → YYYY-MM-DD
    # yyyy年mm月dd日 → YYYY-MM-DD
    pass
```

### 📊 中優先度: CSV形式検証機能
```python
def validate_csv_format(df):
    """
    CSVファイルの形式を検証
    Args:
        df (pandas.DataFrame): 検証対象のDataFrame
    Returns:
        dict: 検証結果
    """
    # ヘッダー確認
    # 列数確認
    # データ型確認
    # 必須列の存在確認
    pass
```

## 🎯 実装計画

### Phase 1: 基本インポート機能（1週間）
1. CSVファイル読み込み機能
2. 基本的な日付形式変換（YYYY-MM-DD、yyyy/mm/dd）
3. データ検証機能
4. DB挿入機能

### Phase 2: 高度な日付形式対応（1週間）
1. 令和形式対応（令和yy年mm月dd日、Ryy/mm/dd）
2. 日本語形式対応（yyyy年mm月dd日）
3. 複数形式の自動検出

### Phase 3: エラーハンドリング強化（3日）
1. 詳細なエラーメッセージ
2. 部分的なインポート機能
3. ロールバック機能

## 📋 技術的考慮事項

### 必要なライブラリ追加
```txt
chardet>=5.0.0  # エンコーディング検出
dateutil>=2.8.0  # 日付解析
```

### データベース設計の拡張
```sql
-- インポート履歴テーブル
CREATE TABLE import_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename TEXT NOT NULL,
    import_date TEXT NOT NULL,
    record_count INTEGER,
    success_count INTEGER,
    error_count INTEGER
);
```

## 🎉 結論

**CSVインポート機能の完全欠如**が最大の問題である。この機能を実装することで、他の家計簿アプリからの移行や、外部データの取り込みが可能になり、システムの実用性が大幅に向上する。

特に、日付形式変換機能の実装により、様々な形式のCSVファイルに対応できるようになり、ユーザビリティが向上する。

## 📝 次のアクション

1. CSVインポート機能の基本実装
2. 日付形式変換機能の実装
3. GUIへのインポートボタン追加
4. エラーハンドリングの強化
